<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Akıllı Ev Kontrol Paneli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --main-bg: #101c2c;
      --card-bg: #182848;
      --accent: #1976d2;
      --accent-dark: #115293;
      --text: #e3eafc;
      --text-light: #b0b8c9;
      --danger: #e74c3c;
      --danger-dark: #c0392b;
      --success: #28a745;
      --success-dark: #218838;
      --yellow: #ffc107;
      --yellow-dark: #e0a800;
      --input-bg: #22304a;
      --input-border: #2c3e5c;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background: var(--main-bg);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      color: var(--text);
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 10px;
    }
    h1 {
      text-align: center;
      color: var(--text);
      margin-bottom: 30px;
    }
    .actions {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-bottom: 30px;
    }
    .actions button {
      padding: 10px 24px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    .actions button:active {
      background: var(--accent-dark);
    }
    .save-bar {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 18px;
    }
    .save-bar button {
      padding: 10px 32px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      background: var(--success);
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
      font-weight: bold;
      letter-spacing: 1px;
    }
    .save-bar button:active {
      background: var(--success-dark);
    }
    .groups {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 24px;
    }
    .group-card {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      transition: box-shadow 0.2s;
      position: relative;
    }
    .group-card .remove-group {
      position: absolute;
      top: 12px;
      right: 12px;
      background: var(--danger);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 18px;
      cursor: pointer;
      line-height: 28px;
      text-align: center;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .group-card .remove-group:active {
      background: var(--danger-dark);
    }
    .group-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--text);
    }
    .group-type {
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 10px;
    }
    .group-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .group-controls button {
      flex: 1;
      padding: 10px 0;
      font-size: 15px;
      border: none;
      border-radius: 6px;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    .group-controls button:active {
      background: var(--accent-dark);
    }
    .group-controls .stop {
      background: var(--yellow);
      color: #222;
    }
    .group-controls .stop:active {
      background: var(--yellow-dark);
    }
    .io-list {
      margin-bottom: 10px;
    }
    .io-list label {
      font-size: 14px;
      color: var(--text-light);
      margin-right: 8px;
    }
    .io-list ul {
      list-style: none;
      padding: 0;
      margin: 0 0 8px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .io-list li {
      background: var(--input-bg);
      border-radius: 5px;
      padding: 4px 10px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--text);
    }
    .io-list .remove-io {
      background: var(--danger);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 13px;
      cursor: pointer;
      line-height: 20px;
      text-align: center;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .io-list .remove-io:active {
      background: var(--danger-dark);
    }
    .io-list .add-io {
      padding: 4px 10px;
      font-size: 13px;
      border: none;
      border-radius: 5px;
      background: var(--success);
      color: #fff;
      cursor: pointer;
      margin-left: 4px;
      transition: background 0.2s;
    }
    .io-list .add-io:active {
      background: var(--success-dark);
    }
    .group-name-input {
      width: 100%;
      padding: 7px 10px;
      border: 1px solid var(--input-border);
      border-radius: 5px;
      margin-bottom: 10px;
      font-size: 15px;
      background: var(--input-bg);
      color: var(--text);
      outline: none;
      transition: border 0.2s;
    }
    .group-name-input:focus {
      border: 1.5px solid var(--accent);
    }
    .status {
      font-size: 14px;
      margin-top: 6px;
      color: var(--text-light);
    }
    .json-modal {
      background: rgba(0,0,0,0.7);
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .json-modal-content {
      background: var(--card-bg);
      color: var(--text);
      border-radius: 10px;
      padding: 24px 18px;
      min-width: 320px;
      max-width: 90vw;
      max-height: 80vh;
      overflow: auto;
      box-shadow: 0 4px 32px rgba(0,0,0,0.25);
      position: relative;
    }
    .json-modal-content pre {
      font-size: 14px;
      background: var(--input-bg);
      color: var(--text);
      border-radius: 6px;
      padding: 12px;
      overflow-x: auto;
    }
    .json-modal-content button {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--danger);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 18px;
      cursor: pointer;
      line-height: 28px;
      text-align: center;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .json-modal-content button:active {
      background: var(--danger-dark);
    }
    @media (max-width: 600px) {
      .groups { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Akıllı Ev Kontrol Paneli</h1>
    <div class="actions">
      <button onclick="addGroup('aydinlatma')">Aydınlatma Ekle</button>
      <button onclick="addGroup('panjur')">Panjur Ekle</button>
    </div>
    <div class="save-bar">
      <button onclick="saveAllGroups()">Kaydet</button>
    </div>
    <div class="groups" id="groups"></div>
  </div>
  <div id="jsonModal" style="display:none"></div>
  <script>
    // Geçici olarak localStorage'da tutulan gruplar (backend ile entegre edebilirsin)
    let groups = JSON.parse(localStorage.getItem('groups') || '[]');

    function saveGroups() {
      localStorage.setItem('groups', JSON.stringify(groups));
    }

    function addGroup(type) {
      if (type === 'panjur') {
        groups.push({
          id: Date.now() + Math.random(),
          name: 'Yeni Panjur',
          type: 'panjur',
          inputs: [],
          outputs: ['Yukarı', 'Aşağı'], // Panjurda sabit iki çıkış
          state: 'dur'
        });
      } else {
        groups.push({
          id: Date.now() + Math.random(),
          name: 'Yeni Aydınlatma',
          type: 'aydinlatma',
          inputs: [],
          outputs: [],
          state: false
        });
      }
      saveGroups();
      renderGroups();
    }

    function removeGroup(id) {
      groups = groups.filter(g => g.id !== id);
      saveGroups();
      renderGroups();
    }

    function updateGroupName(id, value) {
      const g = groups.find(g => g.id === id);
      if (g) g.name = value;
      saveGroups();
    }

    function addIO(id, ioType) {
      const g = groups.find(g => g.id === id);
      if (!g) return;
      const ioList = ioType === 'input' ? g.inputs : g.outputs;
      const ioName = prompt(ioType === 'input' ? 'Giriş adı veya numarası:' : 'Çıkış adı veya numarası:');
      if (ioName) ioList.push(ioName);
      saveGroups();
      renderGroups();
    }

    function removeIO(id, ioType, ioIdx) {
      const g = groups.find(g => g.id === id);
      if (!g) return;
      const ioList = ioType === 'input' ? g.inputs : g.outputs;
      ioList.splice(ioIdx, 1);
      saveGroups();
      renderGroups();
    }

    function toggleAydinlatma(id) {
      const g = groups.find(g => g.id === id);
      if (!g) return;
      g.state = !g.state;
      saveGroups();
      renderGroups();
    }

    function panjurAction(id, action) {
      const g = groups.find(g => g.id === id);
      if (!g) return;
      g.state = action;
      saveGroups();
      renderGroups();
    }

    function saveAllGroups() {
      const json = JSON.stringify(groups, null, 2);
      // Modal ile göster
      showJsonModal(json);
      // İşlemciye gönder (örnek: XMLHttpRequest ile)
      kaydetJsonuLogla(json);
    }

    function showJsonModal(json) {
      const modal = document.getElementById('jsonModal');
      modal.innerHTML = `<div class='json-modal'><div class='json-modal-content'>
        <button onclick='closeJsonModal()' title='Kapat'>&times;</button>
        <h3 style='margin-top:0'>JSON Çıktısı</h3>
        <pre>${json}</pre>
      </div></div>`;
      modal.style.display = '';
    }
    function closeJsonModal() {
      document.getElementById('jsonModal').style.display = 'none';
    }

    // İşlemciye JSON'u loglatmak için örnek fonksiyon
    function kaydetJsonuLogla(json) {
      // Burada backend'e gönderebilirsin. Şimdilik log atalım:
      if (window.XMLHttpRequest) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/save_groups', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(json);
      }
      // Konsola da yaz:
      console.log('KAYDEDİLEN JSON:', json);
    }

    function renderGroups() {
      const container = document.getElementById('groups');
      container.innerHTML = '';
      groups.forEach(g => {
        const card = document.createElement('div');
        card.className = 'group-card';
        card.innerHTML = `
          <button class="remove-group" title="Sil" onclick="removeGroup(${g.id})">&times;</button>
          <input class="group-name-input" value="${g.name}" onchange="updateGroupName(${g.id}, this.value)">
          <div class="group-type">${g.type === 'aydinlatma' ? 'Aydınlatma' : 'Panjur'}</div>
          <div class="io-list">
            <label>Girişler:</label>
            <ul>
              ${g.inputs.map((inp, idx) => `<li>${inp} <button class='remove-io' onclick='removeIO(${g.id}, \"input\", ${idx})'>&times;</button></li>`).join('')}
            </ul>
            <button class="add-io" onclick="addIO(${g.id}, 'input')">Giriş Ekle</button>
          </div>
          <div class="io-list">
            <label>Çıkışlar:</label>
            <ul>
              ${g.type === 'aydinlatma' ?
                g.outputs.map((outp, idx) => `<li>${outp} <button class='remove-io' onclick='removeIO(${g.id}, \"output\", ${idx})'>&times;</button></li>`).join('') :
                g.outputs.map((outp, idx) => `<li>${outp}</li>`).join('')
              }
            </ul>
            ${g.type === 'aydinlatma' ? `<button class="add-io" onclick="addIO(${g.id}, 'output')">Çıkış Ekle</button>` : `<button class="add-io" onclick="editPanjurOutputs(${g.id})">Çıkışları Düzenle</button>`}
          </div>
          <div class="group-controls">
            ${g.type === 'aydinlatma' ?
              `<button onclick="toggleAydinlatma(${g.id})">${g.state ? 'Kapat' : 'Aç'}</button>` :
              `<button onclick="panjurAction(${g.id}, 'up')">Yukarı</button>
               <button class='stop' onclick="panjurAction(${g.id}, 'dur')">Dur</button>
               <button onclick="panjurAction(${g.id}, 'down')">Aşağı</button>`
            }
          </div>
          <div class="status">Durum: <b>${g.type === 'aydinlatma' ? (g.state ? 'Açık' : 'Kapalı') : (g.state === 'up' ? 'Yukarı' : g.state === 'down' ? 'Aşağı' : 'Duruyor')}</b></div>
        `;
        container.appendChild(card);
      });
    }

    // Panjur çıkış isimlerini pop-up ile düzenle
    function editPanjurOutputs(id) {
      const g = groups.find(g => g.id === id);
      if (!g) return;
      const yukari = prompt("Yukarı çıkış ismi veya numarası:", g.outputs[0] || "");
      if (yukari === null) return;
      const asagi = prompt("Aşağı çıkış ismi veya numarası:", g.outputs[1] || "");
      if (asagi === null) return;
      g.outputs[0] = yukari;
      g.outputs[1] = asagi;
      saveGroups();
      renderGroups();
    }

    window.removeGroup = removeGroup;
    window.updateGroupName = updateGroupName;
    window.addIO = addIO;
    window.removeIO = removeIO;
    window.toggleAydinlatma = toggleAydinlatma;
    window.panjurAction = panjurAction;
    window.closeJsonModal = closeJsonModal;
    window.editPanjurOutputs = editPanjurOutputs;

    renderGroups();
  </script>
</body>
</html>